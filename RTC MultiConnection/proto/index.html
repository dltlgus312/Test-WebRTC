<!DOCTYPE html>
<html>
<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<script src="./node_modules/jquery/dist/jquery.min.js"> </script>
<script src="./node_modules/msr/MediaStreamRecorder.min.js"></script>
<script src="/node_modules/rtcmultiConnection/dist/RTCMultiConnection.min.js"></script>

<script src="/node_modules/canvas-designer/dev/webrtc-handler.js"></script>
<script src="/node_modules/canvas-designer/canvas-designer-widget.js"></script>
<script src="/socket.io/socket.io.js"></script>



<style>
	html { height: 100%;}
	
	* { padding: 0; margin: 0; }
	html, body {min-height: 100% !important; height: 100% !important;}
	
	
	#widget-container {width:60%;height:100%;float:left;}
	#url-container {width:10%;height:100%;float:left;background-color:#a0a0f0;text-align:center;}
	#video-container {width:30%;height:90%;float:right;background-color:#8f8f8f;}
	#screen-container {width:100%;height:30%;background-color:#f0f0f0;text-align:center;}
	#button-container {width:30%;height:10%;float:right;}
	#chat-container {width:20%;height:30%;position:fixed;bottom:50px;left:20px;background-color:#faffaf;text-align: center;}
	
	#video-container > video {width:100%; height:32%;margin-top:10px;}
	#screen-container > video {width:100%; height:100%;}
	
	#url-server {width:100%;height:50%;overflow:auto;}
	#url-local {width:100%;height:50%;overflow:auto;}
	
	#chat-contents {width:100%;height:87%;overflow:auto;text-align: left;}
	#chat {width:80%;height:10%;}
	#enter {width:10%;height:10%;}
	
</style>


</head>
<body>

	
	<div id="widget-container"></div>
	
	<div id="url-container">
		<div id="url-server"></div>
		<div id="url-local"></div>
	</div>
	
	<div id="video-container">
		<div id="screen-container">
			<h1 style="padding-top:10%">THIS SCREEN VIDEO AREA</h1>
		</div>
	</div>


	<div id="button-container">
		<button id="screenShare">화면공유</button>
		<button id="videoRecorde">녹화시작</button>
	</div>
	
	<div id="chat-container">
		<div id="chat-contents"></div>
		<input id="chat" type="text" />
		<input id="enter" type="button" value="전송"/>
	</div>



	<script>
		var connection, permission, mediaRecorder, localRecord;
		
		connection = new RTCMultiConnection();
		
		connection.socketURL = '/';
		
		connection.dontCaptureUserMedia = true;
		
		connection.maxParticipantsAllowed = 2;
		
		connection.session = {
			audio: true,
			video: true,
			data: true
		};
		
		
		
		connection.onRoomFull = function(err) {
			alert('방이 꽉 찼습니다. \n ERROR : ' + err);
		};
		
		
		connection.onopen = function(event) {
			if (designer.pointsLength <= 0) {
				setTimeout(function() {
					connection.send('plz-sync-points');
				}, 1000);
			}
		};
		
		
		connection.onstream = function(event) {
			var container;
			var screenBtn = document.getElementById("screenShare");
			if(connection.isInitiator && !mediaRecorder){
				alert("당신은 방의 주인입니다.");
				permission = 'super';
				screenBtn.disabled = false;
				screenBtn.innerHTML = '화면공유';
			}else {				
				permission = 'user';
				screenBtn.disabled = true;
				screenBtn.innerHTML = '방장권한';
			}
		
			if(event.stream.isScreen){
				document.getElementById("screenShare").disabled = true;
				container = document.getElementById('screen-container');
				container.innerHTML  = "";
			}else {			
				container = document.getElementById('video-container');
			}
			
			event.mediaElement.status = 'play';
			event.mediaElement.controls = false;
			container.appendChild( event.mediaElement );
			event.mediaElement.play();
			
			if(permission == 'super'){
				document.getElementById(event.mediaElement.id).onclick = function(){
						if(event.mediaElement.status === 'play'){
							event.mediaElement.status = 'stop';
							connection.send({streamClose : true, id : event.mediaElement.id});
						}
						else {
							event.mediaElement.status = 'play';
							connection.send({streamOpen : true, id : event.mediaElement.id});
						}
				}
				
				if(!mediaRecorder){
					alert("SERVER 녹화 진행");
					<!-- recorde(); -->
					multiRecorde();
				}
			}				
		};
		
		
		
		
		
		
		
		
		
		
		
		
		
		// FUNCTIONS
		<!-- function recorde(){ -->
			<!-- var displayStream;  -->
			<!-- navigator.mediaDevices.getDisplayMedia({video:true}) -->
			<!-- .then((stream)=>{ -->
				<!-- displayStream = stream; -->
				<!-- connection.streamEvents.selectAll({ isVideo:true }).forEach(function(videoStream) { -->
					<!-- 사운드 매핑 -->
					<!-- displayStream.addTrack(videoStream.stream.getAudioTracks()[0]); -->
					<!-- recording(displayStream); -->
				<!-- }); -->
			<!-- }) -->
			<!-- .catch((err)=>{ -->
				<!-- if(err instanceof TypeError){ -->
					<!-- alert('에러 : ' + err); -->
					<!-- recording(displayStream); -->
				<!-- }else { -->
					<!-- alert('방장 녹화는 필수 입니다. 다시 시도해주세요 \n error : ' + err); -->
					<!-- recorde(); -->
				<!-- } -->
				<!-- if(err.constructor === NotAllowedError) NOT WORKING -->
			<!-- }); -->
		<!-- } -->
		
		<!-- function recording(stream){ -->
		
			<!-- mediaRecorder = new MediaStreamRecorder(stream); -->
			<!-- mediaRecorder.mimeType = 'video/mp4;codecs=h264'; -->
			
			<!-- mediaRecorder.ondataavailable = function (data) { -->
				<!-- connection.socket.emit('uploadFile', {data:data}); -->
			<!-- }; -->
			
			<!-- mediaRecorder.start(10 * 1000); -->
		<!-- } -->
		
		
		
		function multiRecorde(){
			var streams = [];
			
			connection.streamEvents.selectAll({ isVideo:true }).forEach(function(event) {
				streams.push(event.stream);
			});
		
			multiRecording(streams);
		}
		
		function multiRecording(streams){
			multiStreamRecorder = new MultiStreamRecorder(streams);
			multiStreamRecorder.mimeType = 'video/mp4;codecs=h264';
			
			multiStreamRecorder.ondataavailable = function (data) {
				connection.socket.emit('uploadFile', {data:data});
			};
			
			multiStreamRecorder.start(3000);
		}
		
		
		
		function myStream(mediaStream, type){
			var myVideo = document.createElement('video');
			myVideo.muted = true;
			myVideo.srcObject = mediaStream;
			myVideo.id = mediaStream.id;
			myVideo.status = 'play';
			
			var container;
			if(type){
				container = document.getElementById('screen-container');
				container.innerHTML  = "";
			}else {
				container = document.getElementById('video-container');
			}
			container.appendChild( myVideo );
			myVideo.play();
			
			myVideo.onclick = function(){
				if(this.status === 'play'){
					this.status = 'stop';
					var tracks = mediaStream.getVideoTracks();
					tracks[0].enabled = false;
				}
				else {
					this.status = 'play';
					var tracks = mediaStream.getVideoTracks();
					tracks[0].enabled = true;
				}
			}
		}
	
		function beforeOpenOrJoin(callback) {
			var videoConstraints = {
				deviceId: window.deviceId ? { exact: window.deviceId } : null,
				width: 1280,
				height: 720
			};
			navigator.mediaDevices.getUserMedia({
					video: videoConstraints
			}).then(async mediaStream => {
			
				navigator.mediaDevices.getUserMedia({
					audio: true
				}).then(async audioStream => {
					
					mediaStream.addTrack(audioStream.getAudioTracks()[0]);
					
					myStream(mediaStream);
					connection.attachStreams = [mediaStream];	
					callback();
				
				}).catch(function(err){
				
					alert("오디오를 확인해주세요");
					myStream(mediaStream);
					connection.attachStreams = [mediaStream];
					callback();
				
				});
			}).catch(function(err) {
				alert("카메라를 확인해주세요.");
			});
		}
		
		function localRecordStart(){
		
			var chunk = [];
			var stream = connection.attachStreams[0];
			var video = document.getElementById(stream.id);
			
			<!-- var options = {mimeType: 'video/webm;codecs=vp9'}; 제한적 지원.. -->
			<!-- var options = {mimeType: 'video/mp4;codecs=h264'}; 지원 안함.. -->
			<!-- localRecord = new MediaRecorder(stream, options); FireFox ( options ) 에러.. -->
			
			localRecord = new MediaRecorder(stream);
				
			localRecord.ondataavailable = function(e) {
				console.log("녹화 중지 : DATA SAVE");
				chunk.push(e.data);
			}
			
			localRecord.onstop = function(){
				console.log("녹화 중지 : ON STOP");
				
				var url = URL.createObjectURL(new Blob(chunk));
				var html = "<a href='" + url + "' download='recorde.webm'> 녹화파일 </a><br/>";
				
				var contain = document.getElementById('url-local');
				contain.innerHTML += html;
				contain.scrollTop = contain.scrollHeight - contain.clientHeight;
				video.style.border = ''
			}
			
			localRecord.start();	
			video.style.border = '3px solid #ff0000'
		}
		
		function chatSend(){
			var chatInput = document.getElementById("chat");
			var chatForm = "<label> 나 : " + chatInput.value + "</label></br>";
			var chatContain = document.getElementById("chat-contents");
			
			chatContain.innerHTML += chatForm;
			chatContain.scrollTop = chatContain.scrollHeight - chatContain.clientHeight;
			
			connection.send( {chat: true, data: chatInput.value} );
			chatInput.value = '';	
		}
		
		
		
		
		
		
		
		
		
		
		
		// CANVAS CONFIG
		var designer = new CanvasDesigner();
		
		designer.widgetHtmlURL = '/node_modules/canvas-designer/widget.html';
		designer.widgetJsURL = '/node_modules/canvas-designer/widget.min.js';
		
		designer.setSelected('pencil');
		
		designer.setTools({
			pencil: true,
			eraser: true,
			image: false,
			pdf: false,
			text: false,
			line: false,
			arrow: false,
			dragSingle: false,
			dragMultiple: false,
			arc: false,
			rectangle: false,
			quadratic: false,
			bezier: false,
			marker: false,
			zoom: false,
			lineWidth: false,
			colorsPicker: false,
			extraOptions: false,
			code: false,
			undo: false
		});
		
		designer.addSyncListener(function(data) {
			connection.send({canvas: true, data: data});
		});
		
		designer.appendTo(document.getElementById('widget-container'));
		
		
		
		
		
		
		
		
		
		
		// DATA LISTENER
		connection.onmessage = function(event) {
			if (event.data === 'plz-sync-points') {
				designer.sync();
				return;
			}
			
			if (event.data.streamClose){
				connection.attachStreams.forEach(function(localStream){
					if(event.data.id === localStream.id){
						var tracks = localStream.getVideoTracks();
						tracks[0].enabled = false;
					}
				});
				return;
			}
			
			if (event.data.streamOpen) {
				connection.attachStreams.forEach(function(localStream){
					if(event.data.id === localStream.id){
						var tracks = localStream.getVideoTracks();
						tracks[0].enabled = true;
					}
				});
				return;
			}
			
			if (event.data.canvas) {
				designer.syncData(event.data.data);
			}
			
			if (event.data.chat){
				var chatForm = "<label> 상대 : " + event.data.data + "</label></br>";
				var chatContain = document.getElementById("chat-contents");
				
				chatContain.innerHTML += chatForm;
				chatContain.scrollTop = chatContain.scrollHeight - chatContain.clientHeight;
			}
		};
		
		
		
		
		
		
		
		
		
		
		
		
		
		// USER EVENT 
		document.getElementById("screenShare").onclick = function (){
			navigator.mediaDevices.getDisplayMedia({
				screen: true
			}).then(async mediaStream => {
				<!-- document.getElementById("screenShare").disabled = true; -->
				mediaStream.isScreen = true;
				myStream(mediaStream, 1);
				connection.addStream(mediaStream);
			});
		};
		
		document.getElementById("videoRecorde").onclick = function (){
			if(this.status == undefined){
				this.status = 'stop'
			}
			
			if(this.status == 'stop'){
				this.status = 'start';
				this.innerHTML = '녹화중지';
				
				localRecordStart();
			}else {
				this.status = 'stop'
				this.innerHTML = '녹화시작';
				
				if(localRecord){
					localRecord.stop();
				}
			}
		}
		
		document.getElementById("enter").onclick = function(){
			chatSend();
		}
		
		document.getElementById("chat").addEventListener("keydown", function(event) {
			var keyPressed = event.keyCode || event.which;
			if (keyPressed === 13) {
				event.preventDefault();
				
				chatSend();
			}
		});
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
		// MAIN START
		beforeOpenOrJoin(function() {
			var roomId='a';
			
			connection.openOrJoin(roomId);
			
			connection.socket.on('uploadURL', (data) => {
				var tagA = "<a href=" + data.url + ">" + data.cnt + "_video</a><br/>";
				var contain = document.getElementById('url-server');
				contain.innerHTML += tagA;
				contain.scrollTop = contain.scrollHeight - contain.clientHeight;
			});
			
			// STACK URL
			connection.socket.on('urls', (data) => {
				data.forEach(function (item, index, array){
					var tagA = "<a href=" + item + ">" + (index+1) + "_video</a><br/>";
					var contain = document.getElementById('url-server');
					contain.innerHTML += tagA;
					contain.scrollTop = contain.scrollHeight - contain.clientHeight;
				});
			});
		});
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
			// BROWSER CLOSE EVENT -- NOT WORKING --
		<!-- connection.onbeforeunload = function() { -->
			<!-- mediaRecorder.stop(); -->
			
			<!-- alert("파일 업로드를 기다려 주세요"); -->
			
			<!-- connection.peers.getAllParticipants().forEach(function(participant) { -->
				<!-- mPeer.onNegotiationNeeded({ -->
					<!-- userLeft: true -->
				<!-- }, participant); -->

				<!-- if (connection.peers[participant] && connection.peers[participant].peer) { -->
					<!-- connection.peers[participant].peer.close(); -->
				<!-- } -->

				<!-- delete connection.peers[participant]; -->
			<!-- }); -->

			<!-- connection.attachStreams.forEach(function(stream) { -->
				<!-- stream.stop(); -->
			<!-- }); -->

			<!-- connection.closeSocket(); -->
			<!-- connection.isInitiator = false; -->
		<!-- }; -->
	</script>


</body>
</html>